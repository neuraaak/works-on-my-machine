name: Deploy Documentation

on:
  workflow_dispatch:
  workflow_call:
    inputs:
      version:
        required: false
        type: string
      tag:
        required: false
        type: string

permissions:
  contents: write

env:
  PACKAGE_NAME: works-on-my-machine
  PYTHON_VERSION: "3.11"
  # DÃ©pendances systÃ¨me supplÃ©mentaires nÃ©cessaires avant l'installation du package
  # Laisser vide si aucune dÃ©pendance systÃ¨me n'est requise
  EXTRA_SYSTEM_DEPS: ""

jobs:
  deploy:
    name: Build and Deploy Docs
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Install extra system dependencies
        if: env.EXTRA_SYSTEM_DEPS != ''
        run: |
          echo "ðŸ“¦ Installing extra system dependencies..."
          pip install ${{ env.EXTRA_SYSTEM_DEPS }} --no-cache-dir

      - name: Install package with docs and test dependencies
        run: |
          echo "ðŸ“¦ Installing package with docs and test dependencies..."
          python -m pip install --upgrade pip
          pip install -e ".[docs,test]"

      - name: Generate coverage report
        run: |
          echo "ðŸ§ª Running tests and generating coverage report..."
          pytest --cov=ezpl --cov-report=html --cov-report=xml -q || true
          echo "âœ… Coverage report generated!"

      - name: Generate changelog
        uses: orhun/git-cliff-action@v4
        with:
          config: cliff.toml
          args: --output docs/changelog.md

      - name: Build and deploy documentation
        run: |
          echo "ðŸ“š Building and deploying documentation for ${{ env.PACKAGE_NAME }}..."
          mkdocs gh-deploy --force
          echo "âœ… Documentation deployed successfully!"
