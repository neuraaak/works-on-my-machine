name: Build and Release

on:
  workflow_dispatch:
    inputs:
      skip_tests:
        description: "Skip tests before releasing (not recommended)"
        required: false
        default: false
        type: boolean
  workflow_call:
    inputs:
      version:
        required: true
        type: string
      tag:
        required: true
        type: string

permissions:
  contents: write
  packages: write

env:
  PACKAGE_NAME: works-on-my-machine

jobs:
  # Job de validation et tests avant build
  validate:
    name: Validate Release
    runs-on: windows-latest
    outputs:
      version: ${{ steps.extract_pyproject_version.outputs.version }}
      tag_name: ${{ steps.extract_tag.outputs.tag_name }}
      tag_version: ${{ steps.extract_tag.outputs.tag_version }}
      version_match: ${{ steps.check_version.outputs.match }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # NÃ©cessaire pour accÃ©der aux tags

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Fetch all branches and tags
        run: |
          git fetch --all --tags --prune
          echo "ğŸ“‹ Available tags:"
          git tag -l

      - name: Extract tag information
        id: extract_tag
        shell: bash
        run: |
          if [ -n "${{ inputs.tag }}" ]; then
            # AppelÃ© via workflow_call depuis auto-tag
            TAG_NAME="${{ inputs.tag }}"
            TAG_VERSION="${{ inputs.version }}"
          else
            # En mode manuel (workflow_dispatch), utiliser le dernier tag -latest ou pyproject.toml
            TAG_NAME=$(git tag -l "v*-latest" --sort=-version:refname | head -n 1)
            if [ -n "$TAG_NAME" ]; then
              # Extraire la version du tag (ex: v1-latest -> utiliser pyproject.toml)
              TAG_VERSION=$(grep -E '^version\s*=\s*"' pyproject.toml | head -1 | sed 's/.*version\s*=\s*"\([^"]*\)".*/\1/')
            else
              # Pas de tag -latest trouvÃ©, utiliser pyproject.toml et crÃ©er un tag
              TAG_VERSION=$(grep -E '^version\s*=\s*"' pyproject.toml | head -1 | sed 's/.*version\s*=\s*"\([^"]*\)".*/\1/')
              TAG_NAME="v${TAG_VERSION%%.*}-latest"
            fi
          fi
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "tag_version=$TAG_VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Tag name: $TAG_NAME"
          echo "ğŸ“¦ Tag version: $TAG_VERSION"

      - name: Extract version from pyproject.toml
        id: extract_pyproject_version
        shell: bash
        run: |
          VERSION=$(grep -E '^version\s*=\s*"' pyproject.toml | head -1 | sed 's/.*version\s*=\s*"\([^"]*\)".*/\1/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ pyproject.toml version: $VERSION"

      - name: Check version consistency
        id: check_version
        shell: bash
        run: |
          TAG_VERSION="${{ steps.extract_tag.outputs.tag_version }}"
          PYPROJECT_VERSION="${{ steps.extract_pyproject_version.outputs.version }}"

          if [ "$TAG_VERSION" != "$PYPROJECT_VERSION" ]; then
            echo "âŒ Version mismatch!"
            echo "   Tag version: $TAG_VERSION"
            echo "   pyproject.toml version: $PYPROJECT_VERSION"
            echo "match=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "âœ… Version consistency check passed"
          echo "match=true" >> $GITHUB_OUTPUT

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run tests
        if: github.event_name != 'workflow_dispatch' || !github.event.inputs.skip_tests
        run: |
          echo "ğŸ§ª Running test suite..."
          pytest tests/ -v --tb=short

      - name: Verify build script
        run: |
          echo "ğŸ” Verifying build script exists..."
          if (Test-Path ".scripts/build/build_exe.py") {
            echo "âœ… Build script found"
          } else {
            echo "âŒ Build script not found"
            exit 1
          }

  # Job de build et release
  build-and-release:
    name: Build and Release
    needs: validate
    runs-on: windows-latest
    if: needs.validate.outputs.version_match == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Clean previous builds
        run: |
          echo "ğŸ§¹ Cleaning previous build artifacts..."
          if (Test-Path "build") { Remove-Item -Recurse -Force "build" }
          if (Test-Path "dist") { Remove-Item -Recurse -Force "dist" }
          Get-ChildItem -Filter "*.egg-info" -Recurse | Remove-Item -Recurse -Force

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Install project (and runtime dependencies) so PyInstaller can collect them
          pip install .
          # Ensure PyInstaller is available (also in dev extras, but explicit here)
          pip install pyinstaller

      - name: Build executable
        run: |
          echo "ğŸ”¨ Building executable..."
          python .scripts/build/build_exe.py build
          echo "ğŸ“¦ Build artifacts:"
          Get-ChildItem -Path dist -Recurse

      - name: Verify executable
        run: |
          echo "ğŸ” Verifying executable exists..."
          if (Test-Path "dist/womm-installer.exe") {
            $size = (Get-Item "dist/womm-installer.exe").Length / 1MB
            echo "âœ… Executable built successfully"
            echo "ğŸ“¦ Size: $([math]::Round($size, 2)) MB"
          } else {
            echo "âŒ Executable not found"
            exit 1
          }

      - name: Create or Update Release
        id: create_release
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ needs.validate.outputs.tag_name }}
          name: WOMM ${{ needs.validate.outputs.tag_name }} - Standalone Installer
          body: |
            ## WOMM Standalone Installer

            This release includes the standalone installer executable for Windows.

            **Version:** `${{ needs.validate.outputs.version }}`

            ### Download
            - **womm-installer.exe** - Windows installer (no Python required)

            ### Installation
            1. Download and run `womm-installer.exe`
            2. Follow the installation prompts
            3. WOMM will be installed to `~/.womm/`

            ### Alternative Installation
            ```bash
            # Via pip
            pip install works-on-my-machine

            # Via git
            git clone https://github.com/neuraaak/works-on-my-machine
            cd works-on-my-machine
            python womm.py install
            ```

            ---
            ğŸ¤– Generated automatically by GitHub Actions
          draft: false
          prerelease: false
          allowUpdates: true
          replacesArtifacts: true
          artifacts: ./dist/womm-installer.exe
          artifactContentType: application/octet-stream

      - name: Show Release Info
        run: |
          echo "âœ… Release created successfully!"
          echo "ğŸ“¦ Package: ${{ env.PACKAGE_NAME }}"
          echo "ğŸ·ï¸  Version: ${{ needs.validate.outputs.version }}"
          echo "ğŸ·ï¸  Tag: ${{ needs.validate.outputs.tag_name }}"
          echo "ğŸ“¦ Asset uploaded: womm-installer.exe"
          echo "ğŸ”— Release URL: ${{ steps.create_release.outputs.html_url }}"
