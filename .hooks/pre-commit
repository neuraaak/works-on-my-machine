#!/bin/bash
# Pre-commit hook for automatic code formatting
# Automatically formats code before allowing commits

# Get project root (parent of .hooks directory)
PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$PROJECT_ROOT"

# Prefer project venv if present
PYTHON_BIN=""
if [ -x "$PROJECT_ROOT/.venv/Scripts/python.exe" ]; then
    PYTHON_BIN="$PROJECT_ROOT/.venv/Scripts/python.exe"
elif [ -x "$PROJECT_ROOT/.venv/bin/python" ]; then
    PYTHON_BIN="$PROJECT_ROOT/.venv/bin/python"
else
    PYTHON_BIN="python"
fi

echo "üîç Running pre-commit formatting..."

# Check if Python is available
if ! command -v "$PYTHON_BIN" &>/dev/null; then
    echo "‚ùå Error: Python not found (venv or PATH)"
    exit 1
fi

# Track overall success
overall_success=true

# Use the lint.py script for formatting (fixes issues automatically)
if [ -f ".scripts/dev/lint.py" ]; then
    echo "üîß Running code quality checks and fixes..."
    if "$PYTHON_BIN" .scripts/dev/lint.py; then
        echo "‚úÖ Code formatting completed"
    else
        echo "‚ùå Code formatting failed"
        overall_success=false
    fi
else
    echo "‚ö†Ô∏è  Warning: .scripts/dev/lint.py not found, using fallback tools..."

    # Fallback to direct tool calls if lint.py is not available
    # Function to check if a tool is available
    check_tool() {
        local tool="$1"
        local command="$2"
        if ! command -v "$command" &>/dev/null; then
            echo "‚ö†Ô∏è  Warning: $tool not found, skipping..."
            return 1
        fi
        return 0
    }

    # Function to run a formatting tool
    run_formatter() {
        local tool="$1"
        local command="$2"
        echo "üîß Running $tool..."
        if eval "$command"; then
            echo "‚úÖ $tool completed"
            return 0
        else
            echo "‚ùå $tool failed"
            return 1
        fi
    }

    # Track overall success
    overall_success=true

    # Run Black (code formatting) - format automatically
    if check_tool "Black" "black"; then
        if ! run_formatter "Black" "black ."; then
            overall_success=false
        fi
    fi

    # Run isort (import sorting) - format automatically
    if check_tool "isort" "isort"; then
        if ! run_formatter "isort" "isort ."; then
            overall_success=false
        fi
    fi

    # Run Ruff format (code formatting) - format automatically
    if check_tool "Ruff" "ruff"; then
        if ! run_formatter "Ruff format" "ruff format ."; then
            overall_success=false
        fi
    fi

    if [ "$overall_success" != true ]; then
        echo "‚ùå Pre-commit formatting failed!"
        overall_success=false
    fi
fi

# Update README version badge from your project's __init__.py before staging
if [ -f ".scripts/dev/update_version.py" ]; then
    echo "üîÑ Updating README version badge..."
    if "$PYTHON_BIN" .scripts/dev/update_version.py; then
        echo "‚úÖ README badge updated"
    else
        echo "‚ö†Ô∏è  Warning: Failed to update README badge (non-blocking)"
    fi
fi

# Add all reformatted files (and updated README) to staging area
if [ "$overall_success" = true ]; then
    echo "üìù Adding reformatted files to staging area..."
    if git add .; then
        echo "‚úÖ Files added to staging area"
    else
        echo "‚ùå Failed to add files to staging area"
        overall_success=false
    fi
fi

# Final result
if [ "$overall_success" = true ]; then
    echo "‚úÖ Pre-commit formatting completed!"
    echo "üí° Code has been automatically formatted and staged for commit."
    exit 0
else
    echo "‚ùå Pre-commit formatting failed!"
    echo ""
    echo "üí° Please fix the issues above and try again."
    echo "üí° You can run formatting manually:"
    echo "   python .scripts/dev/lint.py"
    exit 1
fi
