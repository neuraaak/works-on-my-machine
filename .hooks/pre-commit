#!/bin/bash
# Pre-commit hook for WOMM project
# Automatically formats code before allowing commits

set -e  # Exit on any error

# Get project root (parent of .hooks directory)
PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$PROJECT_ROOT"

echo "🔍 Running pre-commit formatting..."

# Check if Python is available
if ! command -v python &> /dev/null; then
    echo "❌ Error: Python not found in PATH"
    exit 1
fi

# Function to check if a tool is available
check_tool() {
    local tool="$1"
    local command="$2"
    if ! command -v "$command" &> /dev/null; then
        echo "⚠️  Warning: $tool not found, skipping..."
        return 1
    fi
    return 0
}

# Function to run a formatting tool
run_formatter() {
    local tool="$1"
    local command="$2"
    echo "🔧 Running $tool..."
    if eval "$command"; then
        echo "✅ $tool completed"
        return 0
    else
        echo "❌ $tool failed"
        return 1
    fi
}

# Track overall success
overall_success=true

# Run Black (code formatting) - format automatically
if check_tool "Black" "black"; then
    if ! run_formatter "Black" "black ."; then
        overall_success=false
    fi
fi

# Run isort (import sorting) - format automatically
if check_tool "isort" "isort"; then
    if ! run_formatter "isort" "isort ."; then
        overall_success=false
    fi
fi

# Run Ruff format (code formatting) - format automatically
if check_tool "Ruff" "ruff"; then
    if ! run_formatter "Ruff format" "ruff format ."; then
        overall_success=false
    fi
fi

# Note: Ruff lint is intentionally skipped to avoid errors

# Add all reformatted files to staging area
if [ "$overall_success" = true ]; then
    echo "📝 Adding reformatted files to staging area..."
    if git add .; then
        echo "✅ Files added to staging area"
    else
        echo "❌ Failed to add files to staging area"
        overall_success=false
    fi
fi

# Final result
if [ "$overall_success" = true ]; then
    echo "✅ Pre-commit formatting completed!"
    echo "💡 Code has been automatically formatted and staged for commit."
    exit 0
else
    echo "❌ Pre-commit formatting failed!"
    echo ""
    echo "💡 Some formatting tools failed. Please check the output above."
    echo "💡 You can run formatting manually:"
    echo "   black ."
    echo "   isort ."
    echo "   ruff format ."
    echo "   git add ."
    exit 1
fi
